<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
                default-src 'none';
                style-src __CSP_SOURCE__ 'unsafe-inline';
                img-src __CSP_SOURCE__ https: data:;
                font-src __CSP_SOURCE__;
                script-src 'nonce-__NONCE__';
                connect-src 'none';
        ">
  <link href="__STYLES_URI__" rel="stylesheet">
  <title>Minovative Mind Chat</title>
</head>

<body>
  <div class="chat-controls">
    <div class="button-group">
      <button id="save-chat-button" title="Save Chat">S</button>
      <button id="load-chat-button" title="Load Chat">L</button>
      <button id="clear-chat-button" title="Clear Chat">C</button>
      <button id="revert-changes-button" title="Revert Last Plan's Changes" style="display:none;">Revert
        Changes</button>
      <button id="token-usage-toggle" title="Token Usage"></button>
    </div>
  </div>

  <!-- Token Usage Display -->
  <div id="token-usage-container" style="display: none;">
    <div id="token-usage-display">
      <h3>Token Usage Statistics</h3>
      <div class="token-stats">
        <div class="token-stat-item">
          <span class="token-label">Total Input:</span>
          <span class="token-value" id="total-input-tokens">0</span>
        </div>
        <div class="token-stat-item">
          <span class="token-label">Total Output:</span>
          <span class="token-value" id="total-output-tokens">0</span>
        </div>
        <div class="token-stat-item">
          <span class="token-label">Total Tokens:</span>
          <span class="token-value" id="total-tokens">0</span>
        </div>
        <div class="token-stat-item">
          <span class="token-label">Requests:</span>
          <span class="token-value" id="request-count">0</span>
        </div>
        <div class="token-stat-item">
          <span class="token-label">Avg Input:</span>
          <span class="token-value" id="avg-input-tokens">0</span>
        </div>
        <div class="token-stat-item">
          <span class="token-label">Avg Output:</span>
          <span class="token-value" id="avg-output-tokens">0</span>
        </div>
      </div>
    </div>
  </div>

  <div id="status-area"></div>

  <div id="chat-area-wrapper">
    <div id="empty-chat-placeholder">
      <img class="empty-chat-logo" src="__LOGO_URI__">
    </div>

    <div id="chat-container">
      <!-- AI messages will be dynamically added here by JavaScript. The button element is added below within this container for dynamic use. -->
    </div>

    <div id="code-streaming-area" style="display: none;">
      <!-- Streaming code for each file will appear here -->
    </div>
  </div>

  <!-- New location for image previews container as per instructions -->
  <div id="image-previews-container" class="image-previews-container" style="display: none;">
    <!-- Image previews will be dynamically added here by JavaScript -->
  </div>

  <div id="chat-input-controls-wrapper">
    <!-- Google Search Grounding Toggle -->
    <div id="grounding-toggle-container" style="display: flex; align-items: center; margin-bottom: 6px;">
      <label for="grounding-toggle" class="checkbox-toggle-container">
        <input type="checkbox" id="grounding-toggle" class="hidden-checkbox">
        <span class="toggle-switch"></span>
        Google Search
      </label>
    </div>
    <div id="command-suggestions-container" class="command-suggestions-container">
      <!-- Suggestions will be dynamically added here by JavaScript -->
    </div>

    <!-- Original Image Previews Area and its contents moved as per instructions -->
    <div id="input-container">
      <textarea id="chat-input" rows="3" placeholder="Enter message or /plan [request]..."></textarea>

      <div class="input-action-buttons">
        <button id="send-button" title="Send Message">S</button>

        <div class="image-input-action-buttons-container">
          <button id="clear-images-button" title="Clear All Images" style="display: none;"></button>
          <button id="attach-image-button" class="icon-button" title="Attach Image"></button>
        </div>
      </div>

      <!-- Added button to cancel ongoing generation -->
      <button id="cancel-generation-button" title="Cancel Generation" style="display: none;">
        <!-- Assuming Font Awesome is available via the stylesheet -->
        <i class="fas fa-stop"></i>
      </button>
    </div>
    <!-- Hidden file input for image uploads -->
    <input type="file" id="image-upload-input" accept="image/*" multiple style="display: none;">
  </div>

  <!-- Added plan-parse-error-container as per instructions -->
  <div id="plan-parse-error-container" style="display: none;">
    <h3>Plan Generation Failed</h3>

    <p id="plan-parse-error-display" class="error-message-text"></p>

    <h4>Failed JSON (previous attempt):</h4>

    <pre>
      <code id="failed-json-display"></code>
    </pre>

    <div id="plan-parse-error-buttons-wrapper">
      <button id="retry-generation-button" title="Retry Plan Generation"></button>
      <button id="cancel-parse-error-button" title="Cancel Retry"></button>
    </div>
  </div>
  <!-- END Added plan-parse-error-container as per instructions -->

  <div id="commit-review-container" style="display: none;">
    <h3>Review Your Commit</h3>
    <div class="commit-message-section">
      <textarea id="commit-message-textarea" class="commit-message-editor" rows="10" spellcheck="true"
        autocapitalize="off" placeholder="Edit your commit message here..."></textarea>
    </div>
    <div class="staged-files-section">
      <h3>Staged Files</h3>
      <ol id="staged-files-list"></ol>
    </div>
    <div class="commit-review-buttons-wrapper">
      <button id="confirm-commit-button">Confirm and Commit</button>
      <button id="cancel-commit-button">Cancel Commit</button>
    </div>
  </div>

  <div id="chat-clear-confirmation-container" class="confirmation-ui" style="display: none;">
    <h3>Clear All Data?</h3>
    <p>Are you sure you want to delete your entire chat history and <strong>permanently clear all associated revert
        data</strong>? This action cannot be undone.</p>
    <div class="confirmation-buttons-wrapper">
      <button id="confirm-clear-chat-button" title="Yes, Clear All">Yes, Clear All</button>
      <button id="cancel-clear-chat-button" title="No, Keep Them">No, Keep Them</button>
    </div>
  </div>

  <div class="section model-selection-section">
    <h2>AI Model Selection</h2>
    <div class="model-select-container">
      <select id="model-select" title="Select AI Model">__MODEL_OPTIONS_HTML__</select>
    </div>
  </div>

  <div class="section api-key-section">
    <h2>API Key Management</h2>

    <div class="key-management-controls">
      <span id="current-key-display">No keys stored</span>
      <button id="prev-key-button" title="Previous Key" disabled>&lt;</button>
      <button id="next-key-button" title="Next Key" disabled>&gt;</button>
      <button id="delete-key-button" title="Delete Current Key" disabled>Del</button>
    </div>

    <div class="add-key-container">
      <input type="password" id="add-key-input" placeholder="Add new Gemini API Key">
      <button id="add-key-button" title="Add API Key">Add</button>
    </div>

    <div id="api-key-status"></div>

    <p><small>Keys are stored securely using VS Code SecretStorage.</small></p>
  </div>

  <script type="module" nonce="__NONCE__" src="__SCRIPT_URI__"></script>
</body>

</html>